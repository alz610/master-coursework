# Слайд 1

Добрый день, тема “Решение задачи поддержки очереди задач IBM LSF в клиенте запуска расчетов на кластере Scheduler”

IBM Spectrum LSF -- это система очередей задач, позволяющая пользователям запускать задачи на кластере. Кластер состоит из множества вычислительных узлов, каждый из которых имеет набор процессоров и память. Пользователь отправляет задачу, в которой указана последовательность команд, которую он хочет запустить, вместе с описанием вычислительных ресурсов, необходимых для исполнения задачи: время, процессор, ядра, узлы.

Приложение клиент Scheduler позволяет пользователям рассчитывать на кластере гидродинамические модели. В нем поддерживаются системы очередей: Torque, PBS Pro, Slurm. В рамках курсовой работы была поставлена задача поддержки системы очередей IBM Spectrum LSF, поскольку кластеры различаются и у них могут быть установлены различные системы очередей.

## Слайд 2 -- Постановка задачи

1. Установить и настроить IBM LSF
2. Поддержать API для LSF в серверной части Scheduler - скриптов на bash
3. Поддержать команды направляемые напрямую из Sceduler на кластер (статус задачи, остановка, )
4. Протестировать

На блок-схеме изображены отношения между элементами. Каждый элемент не знает о элементах за элементом, с которым он связан. Каждый элемент служит абстракцией.

## Слайд 3 -- Установка и настройка IBM LSF
### Настройка install.config

Настройка значений полей в конфиг-файле `install.config` \cite{install_plan}:

`LSF_ADMINS`: имена пользователей администраторов LSF;

`LSF_TOP`: полный путь директории установки LSF;

`LSF_ADD_SERVERS`: узлы, которые могут ставить задания в очередь и выполнять задания;

`LSF_MASTER_LIST`: узел сервера LSF, который действует как всеобщий координатор для кластера. В каждом кластере есть один главный узел, который выполняет планирование и отправку всех заданий из очереди в узлы для выполнения;

`LSF_ADD_CLIENTS`: узлы, которые могут только ставить задания в очередь;

`LSF_CLUSTER_NAME`: имя кластера LSF;

`CONFIGURATION_TEMPLATE`: шаблон конфигурации для определения начальной конфигурации нового кластера \cite{lsf_overview,host_types_models}.

## Слайд 4 -- Установка и настройка IBM LSF
### Установка

Создание пользователя для администратора LSF и запуск установки LSF

### Запуск

Запуск LSF

## Слайд 5 -- Поддержка API для LSF в серверной части Scheduler
### Скрипты bash

За основу взяты шаблоны задач и скрипты bash системы очередей Torque для поддержки LSF. Шаблоны задач и скрипты Torque переписаны для LSF следующим образом: до стрелки записан код для Torque, который был изменен на код для LSF после стрелки

## Слайд 6 -- Поддержка API для LSF в серверной части Scheduler
### Шаблон задачи

## Слайд 7 -- Поддержка API для LSF в серверной части Scheduler
### Шаблон задачи

## Слайд 8 -- Поддержка команд, направляемы напрямую из Scheduler на кластер

Команды в Scheduler, относящиеся к конкретной системе очередей, хранятся в значениях ключей в словаре (тип данных на Python). Значениям соответствуют либо ссылки на исполняемые на сервере скрипты, либо команды для системы очередей, либо ссылки на методы обработки. Для LSF добавлены следующие значения:

## Слайд 9 -- Поддержка команд, направляемы напрямую из Scheduler на кластер
### Метод QsysCMD.GET_STAT

Метод `QsysCMD.GET_STAT` делает запрос к LSF и грузит JSON статусов задач в кластере LSF, соответствующие моделям, после метод `_update_jstats_lsf` парсит JSON и обновляет статусы моделей. Приведен JSON статуса задачи на презентации со следующими полями:

```
"JOBID": идентификатор задачи, является порядковым номером задачи
"USER": имя пользователя, который отправил задачу в очередь
"STAT": состояние исполнения задачи
"JOB_NAME": имя задачи, содержащее имя модели
"SUBMIT_TIME": дата отправки задачи в очередь
"START_TIME": дата запуска задачи
"FINISH_TIME": дата завершения задачи
"ERROR_FILE": путь к файлу с выводом задачи
"OUTPUT_FILE": путь к файлу с сообщениями задачи о ошибках
"EFFECTIVE_RESREQ": запрошенные ресурсы для задачи: один узел или кол-во ядер в каждом узле
"SLOTS": кол-во всех запрошенных ядер
```

## Слайд 10 -- Поддержка команд, направляемы напрямую из Scheduler на кластер
### Метод _update_jstats_lsf

`_update_jstats_lsf` вызывает метод `_pars_job_json_lsf`, который парсит значения полей JSON статуса задачи и записывает ключ model_name 'имя модели' со значением словарь статуса модели:

```
model_name (имя модели):
    {
        JobStat.ACC_NAME: имя пользователя, который отправил модель на кластер
        JobStat.JOB_NAME: имя задачи расчета, содержащее имя модели
        JobStat.OUT_PATH: путь к файлу с выводом расчета модели
        JobStat.ERR_PATH: путь к файлу с сообщениями расчета модели о ошибках
        JobStat.JOB_STAT: состояние расчета модели
        JobStat.NUM_NODES: кол-во узлов, запрошенных для модели
        JobStat.QUEUE_TIME: дата отправки расчета модели в очередь
        JobStat.START_TIME: дата запуска расчета модели
        JobStat.COMPL_TIME: дата завершения расчета модели
    }
```

## Слайд 11 -- Тестирование
### VirtualBox

Использован программный продукт виртуализации VirtualBox для тестирования. Сервер установлен на виртуальной машине VirtualBox с операционной системой Ubuntu Server 18.04. Клиент запускался в исходной машине и связывался с виртуальной машиной с сервером.

VirtualBox изображен на скриншоте.

## Слайд 12 -- Тестирование
### Виртуальная машина

Изображена виртуальная машина. Изображен запуск LSF в виртуальной машине.

## Слайд 13 -- Тестирование
### Тип расчета: кластерный

Далее изображены тесты сценариев работы Scheduler. Здесь был поставлен расчет с типом кластерный на кластере

## Слайд 14 -- Тестирование
### Тип расчета: кластерный (расш.)

Расчет с типом кластерный расширенный

## Слайд 15 -- Тестирование
### Тип расчета: многопоточный

Расчет с типом многопоточный

## Слайд 16 -- Тестирование
### Рассчитанные кривые модели

Вызвано окно с кривыми модели, которые были посчитаны на кластере

## Слайд 17 -- Заключение

Поддержана очередь задач IBM LSF в клиенте Scheduler: созданы скрипты bash и шаблоны задач для поддержки API для LSF в серверной части Scheduler и поддержаны команды на Python, направляемые напрямую из Scheduler на кластер. Создана и предоставлена виртуальная машина VirtualBox с операционной системой Ubuntu 18.04 с сервером. Создана и предоставлена документация по настройке LSF.


## Слайд 18 -- Спасибо за внимание!
